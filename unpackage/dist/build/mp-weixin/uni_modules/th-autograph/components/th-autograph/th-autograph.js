(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["uni_modules/th-autograph/components/th-autograph/th-autograph"],{"5ae2":function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){}));var i=function(){var t=this,e=t.$createElement,n=(t._self._c,t.history.length),i=t.judge("pencli"),o=t.judge("color"),a=t.judge("back"),r=t.judge("clear");t._isMounted||(t.e0=function(e){t.canvasShow=!0},t.e1=function(e){t.canvasShow=!0}),t.$mp.data=Object.assign({},{$root:{g0:n,m0:i,m1:o,m2:a,m3:r}})},o=[]},"5d25":function(t,e,n){"use strict";(function(t){var i=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=i(n("7eb4")),a=i(n("ee10")),r={props:{canvasId:{type:String,default:"th-".concat(Date.now())},actionBar:{type:Array,default:function(){return["pencli","color","back","clear"]}},isDownload:{type:Boolean,default:!1},horizontalScreen:{type:Boolean,default:!1},fileName:{type:String,default:"签名"},delineColor:{type:String,default:"#000"},delineWidth:{type:Number,default:4},background_name:{type:String,default:"1"}},computed:{background_src:function(){return"/static/model/".concat(this.background_name,".jpg")}},data:function(){return{context:null,history:[],lineColor:this.delineColor,lineWidth:this.delineWidth,canvasShow:!0,bottomHeight:0,canvasWidth:0,canvasHeight:0,toolbarVisible:!0,head_toggle_visible:!0,left_toggle_visible:!0,touchStartY:0,isDragging:!1,startX:0,startY:0,tool_currentX:300,tool_currentY:200,confirm_btn_currentX:290,confirm_btn_currentY:600,offsetX:0,offsetY:0,prompt:"",recorder_manager:null,is_recording:!1,audio_path:"",ref_left:0,ref_top:0,img_path:{ref:"/static/draw/sample_generation.jpg",next_step:""},is_generating_next:!1,is_generating_ref:!1,ref_path:"/static/draw/sample_generation.jpg",ref_layer_hidden:!0,ref_currentY:0,ref_currentX:0,ref_width:160,ref_height:160,text_analyse_timer:null,picture_analyse_timer:null,canPut:!1}},components:{thColor:function(){n.e("uni_modules/th-autograph/components/th-autograph/th-color").then(function(){return resolve(n("b989"))}.bind(null,n)).catch(n.oe)},thLine:function(){n.e("uni_modules/th-autograph/components/th-autograph/th-line").then(function(){return resolve(n("65bd"))}.bind(null,n)).catch(n.oe)}},mounted:function(){var e=this;this.getIphoneBottom(),this.lineColor=this.delineColor,this.lineWidth=this.delineWidth;var n=t.createCanvasContext(this.canvasId,this);this.context=n,this.$nextTick((function(){e.$refs.toggleButton;e.initCanvas()}))},methods:{slider_width_change:function(t){this.ref_width=t.detail.value},slider_height_change:function(t){this.ref_height=t.detail.value},put_ref_img:function(){this.ref_layer_hidden=!1,this.canPut=!0},draw_ref_image:function(){this.context.drawImage(this.ref_path,this.ref_currentX,this.ref_currentY,this.ref_width,this.ref_height),this.context.draw(!0),this.ref_layer_hidden=!0,this.canPut=!1},clear_data:function(){t.request({url:"http://152.136.47.111:25565/clear",method:"GET"})},set_timer:function(){this.text_analyse_timer=setInterval(this.prompt_analyse,1e4),this.picture_analyse_timer=setInterval(this.img_recognition,1e4)},uninstall_timer:function(){clearInterval(this.text_analyse_timer),clearInterval(this.picture_analyse_timer)},prompt_analyse:function(){console.log(this.prompt),""!=this.prompt&&t.request({url:"http://152.136.47.111:25565/process_text_info",method:"POST",data:{text:this.prompt},success:function(t){console.log("文本情绪分析成功",t)},fail:function(e){console.log("情绪分析失败",e),t.showToast({title:"分析失败，请检查连接",position:"bottom"})}})},img_recognition:function(){var e=this;return(0,a.default)(o.default.mark((function n(){var i;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.canvasToFilPath();case 2:i=n.sent,t.uploadFile({url:"http://152.136.47.111:25565/picture_predict",filePath:i,name:"file",success:function(t){console.log("绘画情绪分析成功",t)},fail:function(e){console.log("失败",e),t.showToast({title:"分析失败，请检查连接",position:"bottom"})}});case 4:case"end":return n.stop()}}),n)})))()},generate_ref_img:function(){var e=this;this.is_generating_ref?t.showToast({title:"正在生成中，请稍等~",position:"bottom"}):(this.is_generating_ref=!0,t.request({url:"http://152.136.47.111:25565/generate_ref_img",method:"POST",data:{text:this.prompt},success:function(n){console.log("成功",n);var i=n.data;""==i.image_url?t.showToast({title:"生成失败，请检查网络",position:"bottom"}):e.download_data(i.image_url,"ref"),e.is_generating_ref=!1},fail:function(n){console.log("失败",n),t.showToast({title:"生成失败，请检查连接",position:"bottom"}),e.is_generating_ref=!1}}))},generate_next_img:function(){var e=this;return(0,a.default)(o.default.mark((function n(){var i;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(!e.is_generating_next){n.next=3;break}return t.showToast({title:"正在生成中，请稍等~",position:"bottom"}),n.abrupt("return");case 3:return e.is_generating_next=!0,n.next=6,e.canvasToFilPath();case 6:i=n.sent,t.uploadFile({url:"http://152.136.47.111:25565/generate_next_img",method:"POST",filePath:i,name:"file",formData:{prompt:e.prompt},success:function(n){console.log("成功",n);var i=JSON.parse(n.data);""==i.image_url?t.showToast({title:"生成失败，请联系管理员",position:"bottom"}):e.download_data(i.image_url,"next_step"),e.is_generating_next=!1},fail:function(n){console.log("失败",n),t.showToast({title:"生成失败，请检查连接",position:"bottom"}),e.is_generating_next=!1}});case 8:case"end":return n.stop()}}),n)})))()},toggle_speech_recognition:function(){this.is_recording?this.stop_record():this.start_record()},start_record:function(){var e=this;this.is_recording=!0,this.recorder_manager=t.getRecorderManager(),this.recorder_manager.onStart((function(){console.log("开始录音"),t.showToast({title:"开始录音",position:"bottom",duration:1e3})})),this.recorder_manager.onStop((function(n){console.log("录音停止",n),e.audio_path=n.tempFilePath,e.start_speech_recognition(),t.showToast({title:"录音结束",position:"bottom",duration:1e3})})),this.recorder_manager.onError((function(t){console.log("录音错误",t),e.is_recording=!1})),this.recorder_manager.start({format:"MP3",duration:1e4})},stop_record:function(){this.is_recording=!1,this.recorder_manager.stop()},start_speech_recognition:function(){var e=this;t.uploadFile({url:"http://152.136.47.111:25565/voice_recognition",filePath:this.audio_path,name:"file",success:function(t){console.log("成功",t);var n=JSON.parse(t.data);e.prompt=n.result,console.log(e.prompt)},fail:function(e){console.log("失败",e),t.showToast({title:"语音识别失败，请检查连接",position:"bottom"})}})},download_data:function(e,n){var i=this;t.downloadFile({url:e,success:function(t){console.log("下载成功"),console.log(t.tempFilePath),i.img_path[n]=t.tempFilePath,"next_step"==n&&i.drawNextBackGround()},fail:function(t){console.log("下载失败",t)}})},close:function(){t.redirectTo({url:"/pages/model_select/model_select"})},change_head_toggle_visual:function(){this.head_toggle_visible=!this.head_toggle_visible},change_left_toggle_visual:function(){this.left_toggle_visible=!this.left_toggle_visible},startDrag:function(t,e){this.isDragging=!0;var n=t.touches[0];this.startX=n.clientX,this.startY=n.clientY,"tool"==e?(this.offsetX=this.tool_currentX,this.offsetY=this.tool_currentY):"confirm"==e?(this.offsetX=this.confirm_btn_currentX,this.offsetY=this.confirm_btn_currentY):(this.offsetX=this.ref_currentX,this.offsetY=this.ref_currentY)},dragging:function(t,e){if(this.isDragging){var n=t.touches[0],i=n.clientX-this.startX,o=n.clientY-this.startY;if("tool"==e){this.tool_currentX=Math.min(Math.max(this.offsetX+i,-10),this.canvasWidth-42- -10),this.tool_currentY=Math.min(Math.max(this.offsetY+o,-10),this.canvasHeight-42- -10)}else if("confirm"==e){this.confirm_btn_currentX=Math.min(Math.max(this.offsetX+i,-60),this.canvasWidth-96- -60),this.confirm_btn_currentY=Math.min(Math.max(this.offsetY+o,-20),this.canvasHeight-42- -20)}else{var a=this.ref_width,r=this.ref_height;this.ref_currentX=Math.min(Math.max(this.offsetX+i,-50),this.canvasWidth-a- -50),this.ref_currentY=Math.min(Math.max(this.offsetY+o,-50),this.canvasHeight-r- -50)}}},endDrag:function(){this.isDragging=!1},confirm:function(){this.$emit("confirm")},initCanvas:function(){var e=this,n=t.createSelectorQuery().in(this);n.select(".autograph-box").boundingClientRect((function(t){t?(e.canvasWidth=t.width,e.canvasHeight=t.height,e.drawBackGround()):console.error("未能获取 .autograph-box 节点信息，请检查是否正确渲染")})).exec()},drawBackGround:function(){console.log(this.background_src),this.context.drawImage(this.background_src,0,0,this.canvasWidth,this.canvasHeight),this.context.draw()},drawNextBackGround:function(){this.context.drawImage(this.img_path.next_step,0,0,this.canvasWidth,this.canvasHeight),this.context.draw()},getIphoneBottom:function(){var e=this;t.getSystemInfo({success:function(t){var n=t.screenHeight-t.safeArea.bottom;e.bottomHeight=n>0?n-10:n}})},judge:function(t){return!!this.actionBar.includes(t)},openAction:function(t){this.canvasShow=!1,this.$refs[t].checkModel()},setColor:function(t){this.lineColor=t},setLine:function(t){this.lineWidth=t},checkAction:function(){this.actionShow=!this.actionShow},saveCanvas:function(){var e=this;return(0,a.default)(o.default.mark((function n(){var i;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.canvasToFilPath();case 2:if(i=n.sent,e.isDownload){n.next=6;break}return e.$emit("submit",i),n.abrupt("return",!1);case 6:return n.abrupt("return",new Promise((function(e,n){t.saveImageToPhotosAlbum({filePath:i,success:function(t){this.$emit("submit",i),e(t)},fail:function(t){this.$emit("dowmloadErr",t),n(t)}})})));case 7:case"end":return n.stop()}}),n)})))()},canvasToFilPath:function(){var e=this;return new Promise((function(n,i){t.canvasToTempFilePath({canvasId:e.canvasId,success:function(t){n(t.tempFilePath)},fail:function(t){i(t)}},e)}))},goBack:function(){var t=this;this.context.draw(),this.history.pop(),this.history.forEach((function(e,n){var i=e.style,o=i.color,a=i.width;if(t.context.beginPath(),t.context.setLineCap("round"),t.context.setStrokeStyle(o),t.context.setLineWidth(a),e.coordinates.length>=2)e.coordinates.forEach((function(e){"touchstart"==e.type?t.context.moveTo(e.x,e.y):t.context.lineTo(e.x,e.y)}));else{var r=e.coordinates[0];t.context.moveTo(r.x,r.y),t.context.lineTo(r.x+1,r.y)}t.context.stroke()})),this.context.draw(!0)},clear:function(){this.history=[],this.context.draw()},canvasStart:function(t){var e=t.touches[0],n=e.x,i=e.y;this.history.push({style:{color:this.lineColor,width:this.lineWidth},coordinates:[{type:t.type,x:n,y:i}]}),this.drawGraphics()},canvasMove:function(t){var e=t.touches[0],n=e.x,i=e.y;this.history[this.history.length-1].coordinates.push({type:t.type,x:n,y:i}),this.drawGraphics()},drawGraphics:function(){var t=this.history.length;if(t){var e=this.history[t-1],n=e.coordinates;if(n.length){var i,o;n.length<2?(i=n[n.length-1],o={x:i.x+1,y:i.y}):(i=n[n.length-2],o=n[n.length-1]);var a=e.style;this.context.beginPath(),this.context.setLineCap("round"),this.context.setStrokeStyle(a.color),this.context.setLineWidth(a.width),this.context.moveTo(i.x,i.y),this.context.lineTo(o.x,o.y),this.context.stroke(),this.context.draw(!0)}}}}};e.default=r}).call(this,n("df3c")["default"])},"80f5":function(t,e,n){"use strict";n.r(e);var i=n("5d25"),o=n.n(i);for(var a in i)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(a);e["default"]=o.a},"95d1":function(t,e,n){"use strict";n.r(e);var i=n("5ae2"),o=n("80f5");for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);n("a38d");var r=n("828b"),s=Object(r["a"])(o["default"],i["b"],i["c"],!1,null,"367fdbf1",null,!1,i["a"],void 0);e["default"]=s.exports},a38d:function(t,e,n){"use strict";var i=n("deae"),o=n.n(i);o.a},deae:function(t,e,n){}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'uni_modules/th-autograph/components/th-autograph/th-autograph-create-component',
    {
        'uni_modules/th-autograph/components/th-autograph/th-autograph-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('df3c')['createComponent'](__webpack_require__("95d1"))
        })
    },
    [['uni_modules/th-autograph/components/th-autograph/th-autograph-create-component']]
]);
